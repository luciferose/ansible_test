---
- name: Deploy mezzanine
  host: testserver
  vars:
    user: "{{ ansible_ssh_user }}"
    proj_name: mezzanine-example
    venv_home: "{{ ansible_env.HOME }}"
    venv_path: "{{ venv_home }}/{{ proj_name }}"
    proj_dirname: project
    proj_path: "{{ venv_path }}/{{ proj_dirname }}"
    reqs_path: requirements.txt
    live_hostname: 192.168.0.69
    domains:
      - 192.168.0.69
    repo_url: git@github.com:lorin/mezzanine-example.git
    gunicorn_port: 8000
    locale: en_US.UTF-8
    conf_path: /etc/nginx/conf.d/
    tls_enable: True
    python: "{{ venv_path }}/bin/python"
    database_name: "{{ proj_name }}"
    database_user: "{{ proj_name }}"
    database_host: localhost
    database_port: 5432
    gunicorn_proc_name: mezzanine
  vars_files:
    - secret.yaml
  tasks:
    - name: install yum packages
      yum: name={{ item }} update_cache=yes cache_valid_time=3600
      with_items:
      - git
      - libjpeg-devel
      - libpq-devel
      - memcached
      - nginx
      - postgresql
      - python-devel
      - python-pip
      - python-psycopg2
      - python-setuptools
      - python-virtualenv
      - supervisor
    - name: check out the repository on the host
      git: repo={{ repo_url }} dest={{ proj_path }} accept_hostkey=yes